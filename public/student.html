<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>KNHS | Student Safety</title>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <style>
      :root {
        --primary: #0f172a;
        --accent: #3b82f6;
        --danger: #ef4444;
        --success: #10b981;
        --bg: #f1f5f9;
        --surface: #ffffff;
        --text-main: #1e293b;
        --text-sub: #64748b;
      }

      * {
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
      }

      body {
        font-family: "Inter", sans-serif;
        margin: 0;
        background-color: var(--bg);
        color: var(--text-main);
        height: 100vh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      /* --- ENHANCED SIDEBAR & GLASSMORPHISM --- */
      #sidebar {
        background: linear-gradient(180deg, #0f172a 0%, #f8fafc 100%);
      }

      .sidebar-header {
        background: var(--primary);
        padding: 30px 24px;
        margin: -40px -24px 20px -24px;
        color: #0f172a;
        border-radius: 0 0 20px 20px;
      }

      .guideline-section {
        margin-top: 20px;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      /* --- TABBED GUIDELINES GLASSMORPHISM --- */
      .guidelines-container {
        background: rgba(255, 255, 255, 0.4);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 16px;
        padding: 12px;
        margin-top: 10px;
      }

      .tabs-header {
        display: flex;
        gap: 8px;
        margin-bottom: 15px;
        overflow-x: auto;
        padding-bottom: 5px;
      }

      .tab-btn {
        flex: 1;
        border: none;
        background: rgba(255, 255, 255, 0.5);
        padding: 10px 5px;
        border-radius: 10px;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 5px;
        transition: all 0.3s ease;
        border: 1px solid transparent;
      }

      .tab-btn i {
        font-size: 16px;
      }
      .tab-btn span {
        font-size: 10px;
        font-weight: 700;
        text-transform: uppercase;
      }

      /* Active Tab Styles */
      .tab-btn.active {
        background: var(--surface);
        border-color: var(--accent);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
        transform: translateY(-2px);
      }

      .tab-btn.active i {
        color: var(--accent);
      }

      /* Tab Content */
      .tab-pane {
        display: none;
        animation: fadeIn 0.4s ease;
      }

      .tab-pane.active {
        display: block;
      }

      .guide-content {
        background: rgba(255, 255, 255, 0.6);
        padding: 12px;
        border-radius: 10px;
      }

      .guide-content b {
        display: block;
        color: var(--danger);
        margin-bottom: 8px;
        font-size: 13px;
      }

      .guide-content p {
        margin: 0;
        font-size: 12px;
        line-height: 1.6;
        color: var(--text-main);
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(5px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .guide-desc {
        font-size: 12px;
        line-height: 1.5;
        color: var(--text-sub);
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.4s ease;
      }

      .sidebar-label {
        font-size: 10px;
        font-weight: 800;
        text-transform: uppercase;
        color: var(--text-sub);
        letter-spacing: 1px;
        margin-bottom: 12px;
        display: block;
      }
      #sidebar {
        position: fixed;
        left: -280px;
        top: 0;
        bottom: 0;
        width: 280px;
        background: white;
        z-index: 11000;
        transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        padding: 40px 24px;
        display: flex;
        flex-direction: column;
      }

      #sidebar.active {
        left: 0;
        box-shadow: 20px 0 50px rgba(0, 0, 0, 0.1);
      }

      .sidebar-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.4);
        z-index: 10999;
        display: none;
      }

      .sidebar-overlay.active {
        display: block;
      }

      .contact-item {
        background: #f8fafc;
        padding: 12px;
        border-radius: 10px;
        margin-bottom: 8px;
        border: 1px solid #e2e8f0;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      /* --- LOGIN MODAL --- */
      #login-modal {
        position: fixed;
        inset: 0;
        background: var(--primary);
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 24px;
      }

      .login-box {
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(10px);
        padding: 40px 30px;
        border-radius: 24px;
        width: 100%;
        max-width: 400px;
        text-align: center;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      .login-input {
        width: 100%;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        padding: 16px;
        border-radius: 12px;
        color: white;
        font-size: 16px;
        margin-bottom: 20px;
      }

      .btn-login {
        width: 100%;
        background: var(--accent);
        color: white;
        border: none;
        padding: 16px;
        border-radius: 12px;
        font-weight: 700;
        font-size: 16px;
      }

      /* --- HEADER --- */
      header {
        background: var(--surface);
        padding: 16px 20px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-bottom: 1px solid #e2e8f0;
        z-index: 1001;
      }

      .app-logo {
        font-weight: 800;
        font-size: 18px;
        color: var(--primary);
        display: flex;
        align-items: center;
        gap: 12px;
        cursor: pointer;
      }

      .status-dot {
        width: 8px;
        height: 8px;
        background: var(--success);
        border-radius: 50%;
      }

      /* --- MAP & PIN --- */
      #main-container {
        flex: 1;
        position: relative;
        display: flex;
        flex-direction: column;
      }

      #map-container {
        flex: 1;
        width: 100%;
        z-index: 1;
      }

      #map {
        height: 100%;
        width: 100%;
      }

      .dest-pin {
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .pin-circle {
        width: 45px;
        height: 45px;
        background: var(--danger);
        border-radius: 50%;
        border: 4px solid white;
        box-shadow: 0 0 20px rgba(239, 68, 68, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 20px;
        animation: pulse-pin 1.2s infinite;
      }

      @keyframes pulse-pin {
        0% {
          transform: scale(1);
        }

        50% {
          transform: scale(1.1);
        }

        100% {
          transform: scale(1);
        }
      }

      /* --- ACTIONS --- */
      .actions-tray {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: white;
        border-radius: 24px 24px 0 0;
        padding: 24px 20px 30px 20px;
        z-index: 1002;
        box-shadow: 0 -10px 25px rgba(0, 0, 0, 0.05);
      }

      .alert-banner {
        background: #fef2f2;
        border: 1px solid #fee2e2;
        padding: 12px 16px;
        border-radius: 12px;
        margin: 10px;
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        display: none;
        z-index: 1003;
      }

      #quick-responses {
        display: none;
        margin-bottom: 15px;
      }

      .quick-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
        margin-top: 8px;
      }

      .btn-quick {
        background: #f1f5f9;
        border: 1px solid #e2e8f0;
        border-radius: 10px;
        padding: 10px;
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
      }

      .button-group {
        display: grid;
        grid-template-columns: 1fr 1.5fr;
        gap: 12px;
      }

      .btn-action {
        border: none;
        border-radius: 16px;
        font-weight: 700;
        padding: 16px;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
      }

      .btn-safe {
        background: #f0fdf4;
        color: #15803d;
      }

      .btn-danger {
        background: var(--danger);
        color: white;
      }

      .msg-bar {
        margin-top: 15px;
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        display: flex;
        align-items: center;
        flex-shrink: 0;
      }

      .msg-bar input {
        flex: 1;
        border: none;
        background: transparent;
        padding: 12px;
        outline: none;
      }

      .btn-send {
        background: var(--primary);
        color: white;
        border: none;
        width: 32px;
        height: 32px;
        border-radius: 8px;
        margin-right: 5px;
        cursor: pointer;
      }

      #toast-notification {
        position: fixed;
        top: -100px;
        left: 50%;
        transform: translateX(-50%);
        background: var(--primary);
        color: white;
        padding: 12px 24px;
        border-radius: 99px;
        z-index: 20000;
        transition: 0.5s;
      }

      /* --- PERSISTENT ADMIN MODAL --- */
      #admin-reply-modal {
        position: fixed;
        top: -400px;
        /* Hidden by default */
        left: 50%;
        transform: translateX(-50%);
        background: #1e293b;
        /* Dark Blue Theme */
        color: white;
        width: 90%;
        max-width: 400px;
        padding: 20px;
        border-radius: 16px;
        z-index: 20001;
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.4);
        border: 1px solid rgba(255, 255, 255, 0.1);
        transition: top 0.6s cubic-bezier(0.19, 1, 0.22, 1);
      }

      #admin-reply-modal.active {
        top: 20px;
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
      }

      .modal-badge {
        background: #3b82f6;
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 10px;
        font-weight: 800;
        letter-spacing: 0.5px;
        text-transform: uppercase;
      }

      .btn-close {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        width: 28px;
        height: 28px;
        border-radius: 50%;
        cursor: pointer;
        font-size: 16px;
      }

      .time-stamp {
        margin-top: 16px;
        padding-top: 12px;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        font-size: 11px;
        color: #94a3b8;
        display: flex;
        justify-content: space-between;
      }

      /* --- SIDEBAR USER CARD DESIGN --- */
      .sidebar-user-card {
        background: rgba(15, 23, 42, 0.04); /* Very light navy */
        border: 1px solid rgba(15, 23, 42, 0.08);
        border-radius: 20px;
        padding: 24px 20px;
        margin-bottom: 30px;
        display: flex;
        align-items: center;
        gap: 16px;
        transition: all 0.3s ease;
      }

      .sidebar-user-card:hover {
        background: rgba(59, 130, 246, 0.05); /* Light blue tint on hover */
        border-color: var(--accent);
      }

      .user-avatar {
        font-size: 42px;
        color: var(--accent);
        display: flex;
        align-items: center;
        justify-content: center;
        filter: drop-shadow(0 4px 6px rgba(59, 130, 246, 0.2));
      }

      .user-info {
        display: flex;
        flex-direction: column;
      }

      .welcome-text {
        font-size: 11px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: var(--text-sub);
        margin-bottom: 2px;
      }

      #sidebar-name {
        font-weight: 800;
        margin: 0;
        font-size: 18px;
        color: var(--primary);
        line-height: 1.2;
      }

      #sidebar-id-display {
        color: var(--accent);
        font-size: 12px;
        font-weight: 600;
        margin-top: 4px;
        display: flex;
        align-items: center;
        gap: 5px;
      }

      #sidebar-id-display i {
        font-size: 10px;
      }

      .switch-container {
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: #f8fafc;
        padding: 12px;
        border-radius: 12px;
        border: 1px solid #e2e8f0;
        margin-bottom: 15px;
      }
      .switch-label {
        font-size: 13px;
        font-weight: 700;
        color: var(--text-main);
        display: flex;
        gap: 8px;
        align-items: center;
      }

      /* The Switch Box */
      .switch {
        position: relative;
        display: inline-block;
        width: 44px;
        height: 24px;
      }
      .switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }

      /* The Slider */
      .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #cbd5e1;
        transition: 0.4s;
        border-radius: 34px;
      }
      .slider:before {
        position: absolute;
        content: "";
        height: 18px;
        width: 18px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: 0.4s;
        border-radius: 50%;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      }

      /* Checked State (Active) */
      input:checked + .slider {
        background-color: var(--text-main);
      } /* Dark for Offline Mode */
      input:checked + .slider:before {
        transform: translateX(20px);
      }

      /* SOS STROBE ANIMATION */
      @keyframes strobe {
        0% {
          background-color: #ffffff;
        }
        50% {
          background-color: #ffea00;
        }
        100% {
          background-color: #ffffff;
        }
      }
      .sos-active {
        animation: strobe 0.5s infinite; /* Rapid flash ing */
      }

      /* --- DRAGGABLE FLOATING KIT --- */
      .offline-toolbelt {
        position: fixed;
        bottom: 140px;
        right: 20px;
        display: none; /* Hidden by default */
        flex-direction: column;
        gap: 12px;
        z-index: 2000;
        align-items: center; /* Center items for the handle */
        background: rgba(255, 255, 255, 0.1); /* Subtle backing */
        padding: 10px;
        border-radius: 30px;
        backdrop-filter: blur(2px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        /* Important for dragging */
        touch-action: none;
      }

      /* The Grip Handle */
      .drag-handle {
        width: 40px;
        height: 6px;
        background: rgba(255, 255, 255, 0.5);
        border-radius: 10px;
        cursor: grab;
        margin-bottom: 5px;
      }

      .tool-group {
        display: flex;
        align-items: center;
        position: relative;
      }

      /* Labels appear to the LEFT of the buttons */
      .tool-label {
        position: absolute;
        right: 70px; /* Push to left of button */
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 11px;
        font-weight: 700;
        white-space: nowrap;
        opacity: 0;
        pointer-events: none;
        transition: 0.2s;
      }

      .tool-group:hover .tool-label {
        opacity: 1;
      }

      .tool-btn {
        width: 56px;
        height: 56px;
        border-radius: 50%;
        border: 3px solid rgba(255, 255, 255, 0.2);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        color: white;
        font-size: 20px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .tool-flashlight {
        background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
        color: #facc15;
        border-color: #facc15;
      }
      .tool-sms {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        border-color: #34d399;
      }

      /* --- CENTERED SOS OVERLAY --- */
      #sos-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 20000;
        background: white;
        cursor: pointer;
        /* CENTER CONTENT */
        flex-direction: column;
        align-items: center;
        justify-content: center;
      }

      .sos-text {
        font-size: 80px;
        font-weight: 900;
        color: #ef4444;
        letter-spacing: 10px;
        animation: text-pulse 0.5s infinite alternate;
      }

      @keyframes text-pulse {
        from {
          transform: scale(1);
          opacity: 1;
        }
        to {
          transform: scale(1.1);
          opacity: 0.8;
        }
      }

      .sos-active {
        animation: screen-flash 0.2s infinite alternate;
      }
      @keyframes screen-flash {
        from {
          background: #ffffff;
        }
        to {
          background: #fef08a;
        }
      } /* White to Yellow */

      /* --- NEW: Building Labels on Map --- */
      .bldg-label {
        background: transparent !important; /* No white box */
        border: none !important; /* No border */
        color: #ffffff; /* White text */
        text-shadow:
          -1px -1px 0 #000,
          1px -1px 0 #000,
          -1px 1px 0 #000,
          1px 1px 0 #000,
          0 2px 5px rgba(0, 0, 0, 0.8); /* Black outline & shadow for contrast */
        font-size: 11px;
        font-weight: 900; /* Extra bold */
        text-align: center;
        white-space: nowrap;
        letter-spacing: 0.5px;
        transition: opacity 0.3s ease;
      }

      /* --- NEW: Floating Route Info Card --- */
      #route-info {
        position: absolute;
        top: 80px; /* Positions it below the red Alert Banner */
        left: 50%;
        transform: translateX(-50%);
        background: rgba(15, 23, 42, 0.95);
        backdrop-filter: blur(8px);
        color: white;
        padding: 10px 20px;
        border-radius: 30px;
        display: none; /* Hidden until an alert starts */
        align-items: center;
        gap: 12px;
        z-index: 1005;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        font-size: 13px;
        font-weight: 600;
        width: 90%;
        max-width: 300px;
        justify-content: center;
      }
      /* 1. The Compact 'Dot' Style (Clean Circle) */
      .bldg-dot, .bldg-text {
          opacity: 0; 
          transition: opacity 0.2s ease-in-out;
          pointer-events: auto;
          color: #1e40af; /* Strong blue color */
          font-weight: 900;
          text-shadow: 1px 1px 0px #fff, -1px -1px 0px #fff; /* White outline so blue is readable on dark map */
      }

      .label-visible {
          opacity: 1 !important;
      }

      /* Adjusting the dot style to look better with full text */
      .bldg-dot {
          background: rgba(255, 255, 255, 0.8); /* Light background for the blue text */
          border: 2px solid #1e40af;
          border-radius: 8px;
          padding: 2px 6px;
          white-space: nowrap;
      }
    </style>
  </head>

  <body>
    <div
      id="sos-overlay"
      style="
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 9999;
        cursor: pointer;
      "
      onclick="toggleFlashlight(false)"
    >
      <div
        style="
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          height: 100%;
        "
      >
        <i class="fas fa-lightbulb" style="font-size: 100px; color: black"></i>
        <h1
          style="
            color: black;
            font-weight: 900;
            font-size: 40px;
            margin-top: 20px;
          "
        >
          SOS
        </h1>
        <p style="color: black; font-weight: 700">TAP SCREEN TO STOP</p>
      </div>
    </div>

    <div id="toast-notification"><span id="toast-msg"></span></div>

    <div id="admin-reply-modal">
      <div class="modal-header">
        <span class="modal-badge">New Message</span>
        <button class="btn-close" onclick="closeAdminModal()">&times;</button>
      </div>
      <div
        style="font-size: 15px; line-height: 1.5; font-weight: 500"
        id="admin-msg-content"
      ></div>
      <div class="time-stamp">
        <span>Received:</span>
        <span id="admin-msg-time">--</span>
      </div>
    </div>

    <div
      class="sidebar-overlay"
      id="sidebar-overlay"
      onclick="toggleSidebar(false)"
    ></div>

    <div id="sidebar">
      <div class="sidebar-user-card">
        <div class="user-avatar">
          <i class="fas fa-user-circle"></i>
        </div>
        <div class="user-info">
          <span class="welcome-text">Hello,</span>
          <h2 id="sidebar-name">Student</h2>
          <p id="sidebar-id-display">
            <i class="fas fa-id-badge"></i> ID: Loading...
          </p>
          <p
            id="sidebar-phone-display"
            style="
              color: var(--text-sub);
              font-size: 12px;
              font-weight: 600;
              margin-top: 2px;
            "
          >
            <i class="fas fa-phone"></i> Loading...
          </p>
        </div>
      </div>

      <div
        style="flex: 1; overflow-y: auto; padding-right: 5px; margin-top: 10px"
      >
        <span class="sidebar-label">Safety Guidelines</span>
        <div class="guidelines-container">
          <div class="tabs-header">
            <button
              class="tab-btn active"
              onclick="openTab(event, 'quake-tab')"
            >
              <i class="fas fa-house-crack"></i>
              <span>Earthquake</span>
            </button>
            <button class="tab-btn" onclick="openTab(event, 'fire-tab')">
              <i class="fas fa-fire"></i>
              <span>Fire</span>
            </button>
            <button class="tab-btn" onclick="openTab(event, 'flood-tab')">
              <i class="fas fa-water"></i>
              <span>Flood</span>
            </button>
          </div>

          <div id="quake-tab" class="tab-pane active">
            <div class="guide-content">
              <b>DROP, COVER, HOLD</b>
              <p>
                Stay away from glass and heavy furniture. Move to the Principal
                Front safe zone if instructed.
              </p>
            </div>
          </div>

          <div id="fire-tab" class="tab-pane">
            <div class="guide-content">
              <b>STOP, DROP, ROLL</b>
              <p>
                Cover your nose with a damp cloth. Exit via the nearest
                staircase. Head to the Mendoza or Tejada Court.
              </p>
            </div>
          </div>

          <div id="flood-tab" class="tab-pane">
            <div class="guide-content">
              <b>MOVE TO HIGH GROUND</b>
              <p>
                Avoid walking through flowing water. Stay away from electrical
                outlets and downed power lines.
              </p>
            </div>
          </div>
        </div>

        <span class="sidebar-label" style="margin-top: 24px"
          >Quick Contacts</span
        >
        <div class="contact-item">
          <i class="fas fa-phone" style="color: var(--success)"></i>
          <div style="font-size: 13px"><b>KNHS Clinic:</b> 0912-345-6789</div>
        </div>
        <div class="contact-item">
          <i class="fas fa-shield-halved" style="color: var(--danger)"></i>
          <div style="font-size: 13px"><b>Barangay Help:</b> 911</div>
        </div>
      </div>

      <div
        style="
          background: #f8fafc;
          border: 1px solid #e2e8f0;
          border-radius: 12px;
          padding: 12px;
          margin-top: auto;
          margin-bottom: 10px;
        "
      >
        <div
          style="
            display: flex;
            align-items: center;
            justify-content: space-between;
          "
        >
          <div style="display: flex; align-items: center; gap: 10px">
            <div
              style="
                background: #e2e8f0;
                width: 32px;
                height: 32px;
                border-radius: 8px;
                display: flex;
                align-items: center;
                justify-content: center;
              "
            >
              <i
                class="fas fa-plane-slash"
                style="color: #64748b; font-size: 14px"
              ></i>
            </div>
            <div style="display: flex; flex-direction: column">
              <span
                style="
                  font-size: 13px;
                  font-weight: 700;
                  color: var(--text-main);
                "
                >Offline Mode</span
              >
            </div>
          </div>

          <label class="switch">
            <input
              type="checkbox"
              id="offline-toggle"
              onchange="toggleOfflineMode()"
            />
            <span class="slider"></span>
          </label>
        </div>

        <div
          style="
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            overflow: hidden;
          "
        >
          <div
            style="
              background: #e2e8f0;
              padding: 8px 12px;
              font-size: 11px;
              font-weight: 700;
              color: #475569;
              display: flex;
              align-items: center;
              justify-content: space-between;
            "
          >
            <span>üìç OFFLINE SAFE ZONES</span>
            <i class="fas fa-map-location-dot"></i>
          </div>

          <div style="padding: 10px 12px; border-bottom: 1px solid #f1f5f9">
            <div style="font-weight: 700; font-size: 12px; color: #0f172a">
              Principal Front
            </div>
            <div style="font-size: 10px; color: #64748b; margin-top: 2px">
              <i class="fas fa-arrow-right"></i> Use for
              <b>Earthquake / Fire</b>
            </div>
          </div>

          <div style="padding: 10px 12px; border-bottom: 1px solid #f1f5f9">
            <div style="font-weight: 700; font-size: 12px; color: #0f172a">
              Mendoza Court
            </div>
            <div style="font-size: 10px; color: #64748b; margin-top: 2px">
              <i class="fas fa-arrow-right"></i> Use for <b>Flood / Fire</b>
            </div>
          </div>

          <div style="padding: 10px 12px">
            <div style="font-weight: 700; font-size: 12px; color: #0f172a">
              Tejada Court
            </div>
            <div style="font-size: 10px; color: #64748b; margin-top: 2px">
              <i class="fas fa-arrow-right"></i> Use for <b>Flood / Fire</b>
            </div>
          </div>
        </div>
      </div>
      <button
        onclick="logoutUser()"
        style="
          margin-top: 20px;
          border: none;
          background: #fee2e2;
          color: #b91c1c;
          padding: 14px;
          border-radius: 12px;
          font-weight: 700;
          cursor: pointer;
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 10px;
        "
      >
        <i class="fas fa-power-off"></i> Logout
      </button>
    </div>

    <div id="login-modal">
      <div class="login-box">
        <h2 style="color: white; margin-bottom: 5px">KNHS Safety</h2>
        <p
          id="last-user-hint"
          style="
            color: #94a3b8;
            font-size: 12px;
            margin-bottom: 20px;
            display: none;
          "
        ></p>

        <input
          type="text"
          id="student-id-input"
          class="login-input"
          placeholder="Enter Student ID"
        />
        <button class="btn-login" onclick="loginUser()">Join Network</button>

        <button
          id="btn-quick-access"
          onclick="checkLogin()"
          style="
            display: none;
            width: 100%;
            margin-top: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 12px;
            border-radius: 12px;
            font-weight: 600;
          "
        >
          Continue as <span id="quick-name"></span>
        </button>
      </div>
    </div>

    <header>
      <div class="app-logo" onclick="toggleSidebar(true)">
        <i class="fas fa-bars"></i> KNHS SAFE
      </div>
      <div
        style="display: flex; align-items: center; gap: 8px; font-size: 12px"
      >
        <div class="status-dot" id="conn-dot"></div>
        <span id="conn-text">LIVE</span>
      </div>
    </header>

    <div id="main-container">
      <div id="admin-banner" class="alert-banner">
        <strong id="alert-title" style="color: #991b1b">EMERGENCY</strong>
        <p
          id="admin-banner-text"
          style="font-size: 13px; color: #b91c1c; margin: 4px 0 0 0"
        ></p>
      </div>
      <div id="route-info">
        <i
          class="fas fa-person-running"
          style="color: #fbbf24; font-size: 16px"
        ></i>
        <div style="display: flex; flex-direction: column; line-height: 1.2">
          <div
            style="
              font-size: 9px;
              color: #94a3b8;
              text-transform: uppercase;
              letter-spacing: 0.5px;
            "
          >
            Est. Travel
          </div>
          <div>
            <span id="route-dist" style="color: white">0m</span>
            <span style="color: #64748b; margin: 0 4px">‚Ä¢</span>
            <span id="route-time" style="color: #38bdf8">0 min</span>
          </div>
        </div>
      </div>
      <div id="map-container">
        <div id="map"></div>
      </div>

      <div id="sos-overlay" onclick="toggleFlashlight(false)">
        <div class="sos-text">S.O.S</div>
        <div
          style="
            font-size: 14px;
            font-weight: 700;
            color: black;
            margin-top: 20px;
          "
        >
          TAP SCREEN TO STOP
        </div>
      </div>

      <div id="offline-floating-tools" class="offline-toolbelt">
        <div id="tool-grip" class="drag-handle"></div>

        <div class="tool-group">
          <span class="tool-label">Visual Signal</span>
          <button
            id="btn-flash"
            class="tool-btn tool-flashlight"
            onclick="toggleFlashlight(true)"
          >
            <i class="fas fa-bolt"></i>
          </button>
        </div>

        <div class="tool-group">
          <span class="tool-label">SMS Backup</span>
          <button class="tool-btn tool-sms" onclick="sendOfflineSMS()">
            <i class="fas fa-comment-sms"></i>
          </button>
        </div>
      </div>

      <div class="actions-tray">
        <div
          style="
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
          "
        >
          <span
            style="font-size: 11px; font-weight: 800; color: var(--text-sub)"
            >YOUR LOCATION</span
          >
          <span
            id="nearest-bldg-badge"
            style="
              background: #f1f5f9;
              color: #64748b;
              padding: 4px 8px;
              border-radius: 6px;
              font-size: 11px;
              font-weight: 700;
            "
            >Locating...</span
          >
        </div>
        <div id="quick-responses">
          <span
            style="font-size: 11px; font-weight: 800; color: var(--text-sub)"
            >QUICK RESPONSE</span
          >
          <div class="quick-grid" id="quick-grid"></div>
        </div>
        <div class="button-group">
          <button class="btn-action btn-safe" onclick="markAsSafe()">
            <i class="fas fa-check-circle"></i> I'm Safe
          </button>
          <button class="btn-action btn-danger" onclick="markAsDanger()">
            <i class="fas fa-hand-paper"></i> I am not Safe
          </button>
        </div>
        <div class="msg-bar">
          <input type="text" id="student-note" placeholder="Message Admin..." />
          <button class="btn-send" onclick="sendNote()">
            <i class="fas fa-paper-plane"></i>
          </button>
        </div>
      </div>
    </div>

    <audio
      id="siren"
      loop
      src="https://image2url.com/r2/default/audio/1770035245086-6d368099-59b3-4f94-9f42-a06ce04c585a.mp3"
    ></audio>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

    <script>
      let socket, map, userMarker, routingControl;
      let destMarkers = [];
      let studentID = null;
      let activeDestination = null;

      // PRESERVED YOUR AUDIO URL
      let notificationAudio = new Audio(
        "https://image2url.com/r2/default/audio/1770035478181-9daca647-30be-478d-bef0-2700b5dfcbdd.mp3",
      );

      let hasAskedPermission = false;
      let offlineMarkers = [];
      let currentStatus = "--";

      // --- UPDATED VARIABLES ---
      let isOfflineMode = false;
      let wakeLock = null; // For Flashlight
      const OFFLINE_STORAGE_KEY = "knhs_offline_data";
      const OFFLINE_STATE_KEY = "knhs_is_offline_persistent";

      const LOCATIONS = {
        "PRINCIPAL FRONT": [7.100589893149529, 124.82393056927546],
        "MENDOZA COURT": [7.100077551009359, 124.82369094608939],
        "TEJADA COURT": [7.1001461901808565, 124.82430112059413],
      };

      const BUILDINGS = [
        { name: "BLDG A", coords: [7.100767, 124.824077] },
        { name: "BLDG B", coords: [7.100636, 124.824271] },
        { name: "BLDG C", coords: [7.100458, 124.824615] },
        { name: "BLDG D", coords: [7.100415, 124.824701] },
        { name: "BLDG E", coords: [7.100423, 124.824379] },
        { name: "BLDG F", coords: [7.100282, 124.824365] },
        { name: "BLDG G", coords: [7.100051, 124.824532] },
        { name: "BLDG H", coords: [7.09991, 124.82414] },
        { name: "BLDG I", coords: [7.099777, 124.824108] },
        { name: "BLDG J", coords: [7.099643, 124.824357] },
        { name: "BLDG K", coords: [7.09963, 124.824164] },
        { name: "BLDG L", coords: [7.099713, 124.823939] },
        { name: "BLDG M", coords: [7.099851, 124.823724] },
        { name: "BLDG N", coords: [7.100224, 124.824046] },
        { name: "BLDG O", coords: [7.100439, 124.823966] },
        { name: "BLDG P", coords: [7.100232, 124.82388] },
        { name: "BLDG Q", coords: [7.100362, 124.823746] },
        { name: "BLDG R", coords: [7.100351, 124.823617] },
        { name: "BLDG S", coords: [7.100532, 124.823703] },
      ];

      const DISASTER_ZONES = {
        EARTHQUAKE: ["PRINCIPAL FRONT"],
        FIRE: ["PRINCIPAL FRONT", "MENDOZA COURT", "TEJADA COURT"],
        FLOOD: ["MENDOZA COURT", "TEJADA COURT"],
      };

      const QUICK_MSGS = {
        EARTHQUAKE: ["Trapped", "Injured", "Exit Blocked"],
        FIRE: [" I Can not breathe", "Stuck in room", "Need medical"],
        FLOOD: ["Water rising", "Stuck on roof", "I Can not swim"],
        DEFAULT: ["Need help", "Injured"],
      };

      function urlBase64ToUint8Array(base64String) {
        const padding = "=".repeat((4 - (base64String.length % 4)) % 4);
        const base64 = (base64String + padding)
          .replace(/-/g, "+")
          .replace(/_/g, "/");
        const rawData = window.atob(base64);
        const outputArray = new Uint8Array(rawData.length);
        for (let i = 0; i < rawData.length; ++i) {
          outputArray[i] = rawData.charCodeAt(i);
        }
        return outputArray;
      }

      window.onload = () => {
        initMap();
        initSocket();
        checkLogin();
        loadBuildingLabels();

        if ("serviceWorker" in navigator) {
          navigator.serviceWorker.register("/sw.js").catch(console.error);
        }

        // 1. CHECK PERSISTENT OFFLINE STATE
        const savedOfflineState = localStorage.getItem(OFFLINE_STATE_KEY);
        if (savedOfflineState === "true") {
          const toggle = document.getElementById("offline-toggle");
          if (toggle) toggle.checked = true;
          toggleOfflineMode(true); // Pass 'true' to skip toast on load
        }

        activateGPS();
        checkLogin();

        if ("serviceWorker" in navigator) {
          navigator.serviceWorker.register("/sw.js").catch(console.error);
        }

        setInterval(() => {
          if (!isOfflineMode) checkLogin(true);
        }, 30000);

        const savedName = localStorage.getItem("knhs_student_name");
        if (savedName) {
          document.getElementById("last-user-hint").style.display = "block";
          document.getElementById("last-user-hint").innerText =
            "Last session found";
          document.getElementById("btn-quick-access").style.display = "block";
          document.getElementById("quick-name").innerText =
            savedName.split(" ")[0];
        }
      };

      // --- 1. OFFLINE TOGGLE & LOGIC ---
      function toggleOfflineMode(skipToast = false) {
        const toggle = document.getElementById("offline-toggle");
        const tools = document.getElementById("offline-tools"); // Sidebar tools
        const floatingTools = document.getElementById("offline-floating-tools"); // Floating tools
        const connDot = document.getElementById("conn-dot");
        const connText = document.getElementById("conn-text");

        isOfflineMode = toggle.checked;

        // SAVE STATE
        localStorage.setItem(OFFLINE_STATE_KEY, isOfflineMode);

        if (isOfflineMode) {
          // --- GOING OFFLINE ---
          if (!skipToast) showToast("üîå Offline Mode ENABLED");
          document.body.style.borderTop = "5px solid #64748b";

          // Show Tools
          if (tools) tools.style.display = "block";
          if (floatingTools) floatingTools.style.display = "flex";

          // Update Header Status
          if (connDot) {
            connDot.className = "status-dot offline-badge-active";
            connDot.style.background = "#94a3b8";
          }
          if (connText) connText.innerText = "OFFLINE MODE";

          if (socket) socket.disconnect();

          // Show Pins
          showOfflineSafeZones();
        } else {
          // --- GOING ONLINE ---
          if (!skipToast) showToast("üü¢ Online Mode RESTORED");
          document.body.style.borderTop = "none";

          // Hide Tools
          if (tools) tools.style.display = "none";
          if (floatingTools) floatingTools.style.display = "none";

          // Restore Header
          if (connDot) {
            connDot.className = "status-dot";
            connDot.style.background = "var(--success)";
          }
          if (connText) connText.innerText = "LIVE: " + (studentID || "...");

          toggleFlashlight(false);
          hideOfflineSafeZones();

          if (socket) socket.connect();

          // Trigger Sync
          setTimeout(syncOfflineData, 1000);
        }
      }

      // ACTIVATE DRAGGABLE
      const floater = document.getElementById("offline-floating-tools");
      if (floater) makeDraggable(floater);

      // --- 2. DATA STORAGE & SYNC ---
      function saveOfflineAction(type, content, lat = null, lng = null) {
        const existingData = JSON.parse(
          localStorage.getItem(OFFLINE_STORAGE_KEY) || "[]",
        );
        const newLog = {
          type: type,
          content: content,
          lat: lat,
          lng: lng,
          timestamp: new Date().toISOString(),
        };
        existingData.push(newLog);
        localStorage.setItem(OFFLINE_STORAGE_KEY, JSON.stringify(existingData));
        showToast("Saved to Device (Offline)");
      }

      async function syncOfflineData() {
        const storedData = JSON.parse(
          localStorage.getItem(OFFLINE_STORAGE_KEY) || "[]",
        );
        if (storedData.length === 0) return;

        showToast(`Syncing ${storedData.length} items...`);

        try {
          const response = await fetch("/api/sync", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ id: studentID, logs: storedData }),
          });

          if (response.ok) {
            showToast("‚úÖ Data Synced Successfully!");
            localStorage.removeItem(OFFLINE_STORAGE_KEY);
          } else {
            showToast("‚ö†Ô∏è Sync Failed. Retrying later.");
          }
        } catch (error) {
          console.error("Sync Error:", error);
          showToast("‚ö†Ô∏è Sync Failed (No Internet)");
        }
      }

      // --- 3. STUDENT ACTIONS (OFFLINE AWARE) ---

      function sendNote() {
        const input = document.getElementById("student-note");
        const msg = input.value.trim();

        if (msg && studentID) {
          if (isOfflineMode) {
            saveOfflineAction("NOTE", msg);
            input.value = "";
          } else {
            if (socket)
              socket.emit("student-note", { id: studentID, message: msg });
            input.value = "";
            showToast("Sent");
          }
        }
      }

      function markAsDanger() {
        if (!studentID) return;

        if (isOfflineMode) {
          const lat = userMarker ? userMarker.getLatLng().lat : null;
          const lng = userMarker ? userMarker.getLatLng().lng : null;
          currentStatus = "DANGER";
          saveOfflineAction("STATUS", "DANGER", lat, lng);
        } else {
          currentStatus = "DANGER";
          if (userMarker) {
            const lat = userMarker.getLatLng().lat;
            const lng = userMarker.getLatLng().lng;
            socket.emit("student-status", {
              id: studentID,
              status: "DANGER",
              lat: lat,
              lng: lng,
            });
            showToast("SOS Sent! Location Shared.");
          } else {
            showToast("Acquiring GPS...");
            navigator.geolocation.getCurrentPosition(
              (pos) => {
                const lat = pos.coords.latitude;
                const lng = pos.coords.longitude;
                if (!userMarker) {
                  userMarker = L.circleMarker([lat, lng], {
                    radius: 8,
                    color: "#3b82f6",
                    fillColor: "white",
                    fillOpacity: 1,
                    weight: 3,
                  }).addTo(map);
                  map.setView([lat, lng], 19);
                }
                socket.emit("student-status", {
                  id: studentID,
                  status: "DANGER",
                  lat: lat,
                  lng: lng,
                });
                showToast("SOS Sent! Location Shared.");
              },
              (err) => {
                alert("‚ö†Ô∏è GPS Error: Please allow location access.");
              },
              { enableHighAccuracy: true },
            );
          }
        }
      }

      function sendQuickMsg(text) {
        if (isOfflineMode) {
          currentStatus = "DANGER";
          saveOfflineAction("NOTE", `[QUICK SOS]: ${text}`);
          saveOfflineAction("STATUS", "DANGER");
        } else {
          markAsDanger();
          if (socket)
            socket.emit("student-note", {
              id: studentID,
              message: `[QUICK SOS]: ${text}`,
            });
          showToast("Alert Sent!");
        }
      }

      // --- 4. OFFLINE TOOLS (IMPROVED FLASHLIGHT & SMS) ---

      async function toggleFlashlight(turnOn) {
        const overlay = document.getElementById("sos-overlay");
        const btn = document.getElementById("btn-flash");

        if (turnOn) {
          overlay.style.display = "flex";
          overlay.classList.add("sos-active");
          if (btn) btn.classList.add("flash-on");
          try {
            if ("wakeLock" in navigator) {
              wakeLock = await navigator.wakeLock.request("screen");
            }
          } catch (err) {
            console.log("Wake Lock Error:", err);
          }
        } else {
          overlay.style.display = "none";
          overlay.classList.remove("sos-active");
          if (btn) btn.classList.remove("flash-on");
          if (wakeLock !== null) {
            await wakeLock.release();
            wakeLock = null;
          }
        }
      }

      function sendOfflineSMS() {
        const targetNumber = "09465025720";
        const id = studentID || "UNKNOWN_ID";
        const name =
          document.getElementById("sidebar-name").innerText || "Student";
        let locString = "Unknown Location";
        if (userMarker) {
          const lat = userMarker.getLatLng().lat.toFixed(5);
          const lng = userMarker.getLatLng().lng.toFixed(5);
          locString = `${lat}, ${lng}`;
        } else {
          const lastLog = JSON.parse(
            localStorage.getItem(OFFLINE_STORAGE_KEY) || "[]",
          ).pop();
          if (lastLog && lastLog.lat) {
            locString = `${lastLog.lat}, ${lastLog.lng} (Old)`;
          }
        }
        const message = `SOS! ID: ${id} (${name}) - I am OFFLINE.\nLOC: ${locString}\nNeed Help!`;
        window.open(
          `sms:${targetNumber}?body=${encodeURIComponent(message)}`,
          "_parent",
        );
      }

      function showOfflineSafeZones() {
        hideOfflineSafeZones();
        let nearestZone = null;
        let minDistance = Infinity;
        let userLatLng = userMarker ? userMarker.getLatLng() : null;

        Object.keys(LOCATIONS).forEach((name) => {
          const coords = LOCATIONS[name];
          let distLabel = "";
          if (userLatLng) {
            const dist = map.distance(userLatLng, coords);
            distLabel = `<br>Distance: <b>${Math.round(dist)} meters</b>`;
            if (dist < minDistance) {
              minDistance = dist;
              nearestZone = { name: name, coords: coords };
            }
          }
          const pinIcon = L.divIcon({
            className: "dest-pin",
            html: `<div class="pin-circle" style="background: #10b981; border-color: white;"><i class="fas fa-shield-alt"></i></div>`,
            iconSize: [40, 40],
            iconAnchor: [20, 20],
          });
          const marker = L.marker(coords, { icon: pinIcon })
            .addTo(map)
            .bindPopup(`<b>OFFLINE SAFE ZONE</b><br>${name}${distLabel}`);
          offlineMarkers.push(marker);
        });

        if (userLatLng && nearestZone) {
          const guidanceLine = L.polyline([userLatLng, nearestZone.coords], {
            color: "#facc15",
            weight: 6,
            dashArray: "15, 15",
            opacity: 0.8,
          }).addTo(map);
          offlineMarkers.push(guidanceLine);
          const popup = L.popup()
            .setLatLng(nearestZone.coords)
            .setContent(
              `<b>NEAREST SAFE ZONE</b><br>${nearestZone.name}<br>(${Math.round(minDistance)}m away)`,
            )
            .openOn(map);
          offlineMarkers.push(popup);
          const bounds = L.latLngBounds([userLatLng, nearestZone.coords]);
          map.fitBounds(bounds, { padding: [80, 80] });
          showToast(`üìç Nearest Zone: ${nearestZone.name}`);
        } else {
          if (offlineMarkers.length > 0) {
            const group = new L.featureGroup(offlineMarkers);
            map.fitBounds(group.getBounds(), { padding: [50, 50] });
          }
        }
      }

      function hideOfflineSafeZones() {
        offlineMarkers.forEach((marker) => map.removeLayer(marker));
        offlineMarkers = [];
      }

      // --- 5. SYSTEM FUNCTIONS ---
      async function subscribeToPush() {
        if ("serviceWorker" in navigator) {
          try {
            const register = await navigator.serviceWorker.ready;
            let subscription = await register.pushManager.getSubscription();
            if (!subscription) {
              const response = await fetch("/api/vapid-key");
              const json = await response.json();
              const publicKey = json.publicKey;
              if (publicKey) {
                subscription = await register.pushManager.subscribe({
                  userVisibleOnly: true,
                  applicationServerKey: urlBase64ToUint8Array(publicKey),
                });
              }
            }
            if (subscription) {
              await fetch("/subscribe", {
                method: "POST",
                body: JSON.stringify(subscription),
                headers: { "content-type": "application/json" },
              });
              if (!hasAskedPermission) {
                showToast("Emergency Alerts Active ‚úÖ");
              }
            }
          } catch (err) {
            console.error("Push Setup Error:", err);
          }
        }
      }

      function initMap() {
        map = L.map("map", {
          zoomControl: false,
          attributionControl: false,
        }).setView([7.1002, 124.824], 19);
        L.tileLayer(
          "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
        ).addTo(map);

        map.on("zoomend", function () {
          updateLabelVisibility();
        });
      }

      function initSocket() {
        if (typeof io !== "undefined") {
          socket = io();
          socket.on("connect", () => {
            updateStatus(true);
            if (studentID) socket.emit("register-student", studentID);
          });
          socket.on("disconnect", () => updateStatus(false));
          socket.on("receive-reply", (data) => {
            notificationAudio.currentTime = 0;
            notificationAudio
              .play()
              .catch((e) => console.log("Audio block:", e));
            if (document.hidden && Notification.permission === "granted") {
              navigator.serviceWorker.ready.then((reg) => {
                reg.showNotification("New Admin Message", {
                  body: data.message,
                  icon: "https://cdn-icons-png.flaticon.com/512/10303/10303033.png",
                });
              });
            }
            const now = new Date();
            const dateStr = now.toLocaleDateString("en-US", {
              month: "short",
              day: "numeric",
              year: "numeric",
            });
            const timeStr = now.toLocaleTimeString("en-US", {
              hour: "numeric",
              minute: "2-digit",
              hour12: true,
            });
            document.getElementById("admin-msg-content").innerText =
              data.message;
            document.getElementById("admin-msg-time").innerText =
              `${dateStr} ‚Ä¢ ${timeStr}`;
            document
              .getElementById("admin-reply-modal")
              .classList.add("active");
          });
          socket.on("receive-alert", handleAlert);
        }
      }

      function closeAdminModal() {
        document.getElementById("admin-reply-modal").classList.remove("active");
        notificationAudio.pause();
        notificationAudio.currentTime = 0;
      }

      async function checkLogin(isHeartbeat = false) {
        try {
          const response = await fetch("/api/me");

          if (response.ok) {
            const data = await response.json();

            if (data.id) {
              // 1. SUCCESSFUL LOGIN: Save credentials for future "Continue as" use
              localStorage.setItem("knhs_student_id", data.id);
              localStorage.setItem("knhs_student_name", data.name);
              localStorage.setItem(
                "knhs_student_phone",
                data.phone_number || "No Phone",
              );

              studentID = data.id;

              // 2. UPDATE UI: Fill Sidebar and hide the Login Modal
              document.getElementById("sidebar-id-display").innerHTML =
                `<i class="fas fa-id-badge"></i> ID: ${data.id}`;
              document.getElementById("sidebar-name").innerText =
                data.name.split(" ")[0];
              document.getElementById("sidebar-phone-display").innerHTML =
                `<i class="fas fa-phone"></i> ${data.phone_number || "N/A"}`;

              document.getElementById("conn-text").innerText =
                "LIVE: " + data.id;
              document.getElementById("login-modal").style.display = "none";

              if (socket && !isHeartbeat)
                socket.emit("register-student", studentID);
              return;
            }
          }
        } catch (error) {
          console.warn("Session check failed, possibly offline.");
        }

        // 3. FALLBACK/NOT LOGGED IN: Look for saved data in LocalStorage
        const cachedID = localStorage.getItem("knhs_student_id");
        const cachedName = localStorage.getItem("knhs_student_name");
        const cachedPhone = localStorage.getItem("knhs_student_phone");

        if (cachedID && cachedName) {
          // 4. ACTIVATE BUTTON: Make the "Continue as" button visible
          document.getElementById("last-user-hint").style.display = "block";
          document.getElementById("last-user-hint").innerText =
            "Previous session found";

          const quickAccessBtn = document.getElementById("btn-quick-access");
          quickAccessBtn.style.display = "block";

          // Update the span inside the button with the student's first name
          document.getElementById("quick-name").innerText =
            cachedName.split(" ")[0];

          // Pre-fill the input field with the Student ID
          document.getElementById("student-id-input").value = cachedID;

          // 5. OFFLINE DATA DISPLAY: Update sidebar with cached info just in case
          studentID = cachedID;
          document.getElementById("sidebar-id-display").innerHTML =
            `<i class="fas fa-id-badge"></i> ID: ${cachedID} (Offline)`;
          document.getElementById("sidebar-name").innerText =
            cachedName.split(" ")[0];
          document.getElementById("sidebar-phone-display").innerHTML =
            `<i class="fas fa-phone"></i> ${cachedPhone || "N/A"}`;
        }
      }

      function handleAlert(data) {
        const banner = document.getElementById("admin-banner");
        const routeInfo = document.getElementById("route-info");
        const siren = document.getElementById("siren");
        const quickTray = document.getElementById("quick-responses");
        const quickGrid = document.getElementById("quick-grid");

        if (data.type === "SAFE" || data.type === "CLEAR") {
          banner.style.display = "none";
          routeInfo.style.display = "none";
          quickTray.style.display = "none"; // Hide quick messages on clear
          if (siren) {
            siren.pause();
            siren.currentTime = 0;
          }

          if (routingControl) {
            map.removeControl(routingControl);
            routingControl = null;
          }
          destMarkers.forEach((m) => map.removeLayer(m));
          destMarkers = [];
          activeDestination = null;
        } else {
          banner.style.display = "block";
          document.getElementById("alert-title").innerText = data.type + " ALERT";
          document.getElementById("admin-banner-text").innerText = data.message;

          // --- NEW: POPULATE QUICK MESSAGES ---
          quickTray.style.display = "block";
          quickGrid.innerHTML = ""; // Clear old buttons
          const msgs = QUICK_MSGS[data.type] || QUICK_MSGS.DEFAULT;
          msgs.forEach(msg => {
            const btn = document.createElement("button");
            btn.className = "btn-quick";
            btn.innerText = msg;
            btn.onclick = () => sendQuickMsg(msg);
            quickGrid.appendChild(btn);
          });

          if (siren) {
            siren.volume = 1.0;
            siren.play().catch(() => {});
          }

          const allowedZones = DISASTER_ZONES[data.type] || ["PRINCIPAL FRONT"];
          const bestZone = getNearestSafeZone(allowedZones);

          if (bestZone) {
            activeDestination = bestZone.coords;
            // Show the route info card
            routeInfo.style.display = "flex"; 
            
            if (userMarker) {
              startRouting(userMarker.getLatLng(), bestZone.coords);
            } else {
              navigator.geolocation.getCurrentPosition((pos) => {
                const currentPos = L.latLng(pos.coords.latitude, pos.coords.longitude);
                startRouting(currentPos, bestZone.coords);
              });
            }
          }
        }
      }

      // Helper to find closest safe zone
      function getNearestSafeZone(zoneNames) {
        if (!userMarker)
          return { name: zoneNames[0], coords: LOCATIONS[zoneNames[0]] };

        let best = null;
        let min = Infinity;
        const userLoc = userMarker.getLatLng();

        zoneNames.forEach((name) => {
          const coords = LOCATIONS[name];
          const dist = map.distance(userLoc, coords);
          if (dist < min) {
            min = dist;
            best = { name, coords };
          }
        });
        return best;
      }

      // Helper to draw the line and show stats
      function startRouting(start, end) {
        if (routingControl) {
          map.removeControl(routingControl);
          routingControl = null;
        }
        destMarkers.forEach((m) => map.removeLayer(m));
        destMarkers = [];

        const pinIcon = L.divIcon({
          className: "dest-pin",
          html: `<div class="pin-circle"><i class="fas fa-person-running"></i></div>`,
          iconSize: [45, 45],
          iconAnchor: [22, 22],
        });
        const destMarker = L.marker(end, { icon: pinIcon }).addTo(map);
        destMarkers.push(destMarker);

        routingControl = L.Routing.control({
          waypoints: [
            L.latLng(start.lat, start.lng),
            L.latLng(end[0], end[1])
          ],
          createMarker: () => null,
          lineOptions: {
            styles: [
              { color: "white", weight: 9, opacity: 0.6 }, 
              { color: "#ef4444", weight: 5, opacity: 1 }   
            ],
            addWaypoints: false
          },
          router: L.Routing.osrmv1({
            serviceUrl: `https://router.project-osrm.org/route/v1`
          }),
          show: false,
          addWaypoints: false,
          draggableWaypoints: false,
          fitSelectedRoutes: true // Auto-zoom to show the whole path
        }).addTo(map);

        routingControl.on("routesfound", function (e) {
          const routes = e.routes;
          const summary = routes[0].summary;
          document.getElementById("route-info").style.display = "flex";
          document.getElementById("route-dist").innerText = Math.round(summary.totalDistance) + "m";
          document.getElementById("route-time").innerText = Math.ceil(summary.totalTime / 60) + " min";
        });
      }

      // --- RESTORED: OLD ROUTING LOGIC (With Dynamic Updates) ---
      function drawPath(start, end) {
        if (routingControl) {
          // Update existing path (Efficient)
          routingControl.setWaypoints([start, end]);
        } else {
          // Create new path (Standard)
          routingControl = L.Routing.control({
            waypoints: [start, end],
            createMarker: () => null, // Hide default markers
            lineOptions: {
              styles: [
                { color: "white", weight: 8, opacity: 0.5 },
                { color: "#ef4444", weight: 6, opacity: 0.9 },
              ],
            },
            show: false, // Hide instruction container
            addWaypoints: false,
            draggableWaypoints: false,
            fitSelectedRoutes: false, // Prevent auto-zoom on update
          }).addTo(map);
        }
      }

      function findNearestZone(allowedZones) {
        if (!userMarker)
          return { nearest: LOCATIONS[allowedZones[0]], all: allowedZones };
        const userLat = userMarker.getLatLng().lat;
        const userLng = userMarker.getLatLng().lng;
        let nearestCoords = null;
        let minDist = Infinity;

        allowedZones.forEach((zoneKey) => {
          const [zLat, zLng] = LOCATIONS[zoneKey];
          const dist = Math.sqrt(
            Math.pow(zLat - userLat, 2) + Math.pow(zLng - userLng, 2),
          );
          if (dist < minDist) {
            minDist = dist;
            nearestCoords = LOCATIONS[zoneKey];
          }
        });
        return nearestCoords;
      }

      function toggleSidebar(show) {
        document.getElementById("sidebar").classList.toggle("active", show);
        document
          .getElementById("sidebar-overlay")
          .classList.toggle("active", show);
      }

      function markAsSafe() {
        if (socket && studentID) {
          if (!confirm("Are you sure you have received help and are now SAFE?"))
            return;
          currentStatus = "SAFE";

          // Clean up Routing
          if (routingControl) {
            map.removeControl(routingControl);
            routingControl = null;
          }
          activeDestination = null;

          socket.emit("student-status", {
            id: studentID,
            status: "SAFE",
            lat: userMarker?.getLatLng().lat,
            lng: userMarker?.getLatLng().lng,
          });
          const siren = document.getElementById("siren");
          if (siren) {
            siren.pause();
            siren.currentTime = 0;
          }
          showToast("Status: Safe");
        }
      }

      function testAudio() {
        const siren = document.getElementById("siren");
        if (siren) {
          siren.volume = 1.0;
          siren.currentTime = 0;
          siren
            .play()
            .then(() => {
              showToast("Playing Sound...");
              setTimeout(() => siren.pause(), 3000);
            })
            .catch((e) =>
              alert(
                "Audio Error: " +
                  e.message +
                  "\n\nTip: Interact with the page first!",
              ),
            );
        }
      }

      function showToast(text) {
        const toast = document.getElementById("toast-notification");
        document.getElementById("toast-msg").innerText = text;
        toast.style.top = "20px";
        setTimeout(() => (toast.style.top = "-100px"), 4000);
      }

      function logoutUser() {
        window.location.href = "/logout";
      }

      function activateGPS() {
        if (navigator.geolocation) {
          navigator.geolocation.watchPosition(
            (pos) => {
              const lat = pos.coords.latitude,
                lng = pos.coords.longitude;
              const newLatLng = new L.LatLng(lat, lng);

              if (!userMarker) {
                userMarker = L.circleMarker(newLatLng, {
                  radius: 8,
                  color: "#3b82f6",
                  fillColor: "white",
                  fillOpacity: 1,
                  weight: 3,
                }).addTo(map);
                map.setView(newLatLng, 19);
              } else {
                userMarker.setLatLng(newLatLng);
              }

              // --- NEW: Calculate Nearest Building on every move ---
              findNearestBuilding(newLatLng);

              // --- DYNAMIC ROUTE UPDATE (USING RESTORED LOGIC) ---
              if (activeDestination) {
                // If the student is being routed to a safe zone, update the line as they move
                drawPath(newLatLng, activeDestination);
              }

              if (socket && studentID && !isOfflineMode) {
                socket.emit("student-status", {
                  id: studentID,
                  lat: lat,
                  lng: lng,
                  status: currentStatus,
                });
              }
            },
            null,
            { enableHighAccuracy: true },
          );
        }
      }

      function updateStatus(online) {
        document.getElementById("conn-dot").style.background = online
          ? "var(--success)"
          : "var(--danger)";
        document.getElementById("conn-text").innerText =
          online && studentID ? "LIVE: " + studentID : "OFFLINE";
      }

      // --- DRAGGABLE LOGIC ---
      function makeDraggable(element) {
        let pos1 = 0,
          pos2 = 0,
          pos3 = 0,
          pos4 = 0;
        const grip = document.getElementById("tool-grip");
        if (grip) {
          grip.onmousedown = dragMouseDown;
          grip.ontouchstart = dragTouchStart;
        } else {
          element.onmousedown = dragMouseDown;
          element.ontouchstart = dragTouchStart;
        }

        function dragMouseDown(e) {
          e = e || window.event;
          e.preventDefault();
          pos3 = e.clientX;
          pos4 = e.clientY;
          document.onmouseup = closeDragElement;
          document.onmousemove = elementDrag;
        }

        function elementDrag(e) {
          e = e || window.event;
          e.preventDefault();
          pos1 = pos3 - e.clientX;
          pos2 = pos4 - e.clientY;
          pos3 = e.clientX;
          pos4 = e.clientY;
          element.style.top = element.offsetTop - pos2 + "px";
          element.style.left = element.offsetLeft - pos1 + "px";
        }

        function dragTouchStart(e) {
          const touch = e.touches[0];
          pos3 = touch.clientX;
          pos4 = touch.clientY;
          document.ontouchend = closeDragElement;
          document.ontouchmove = elementTouchDrag;
        }

        function elementTouchDrag(e) {
          const touch = e.touches[0];
          pos1 = pos3 - touch.clientX;
          pos2 = pos4 - touch.clientY;
          pos3 = touch.clientX;
          pos4 = touch.clientY;
          element.style.top = element.offsetTop - pos2 + "px";
          element.style.left = element.offsetLeft - pos1 + "px";
        }

        function closeDragElement() {
          document.onmouseup = null;
          document.onmousemove = null;
          document.ontouchend = null;
          document.ontouchmove = null;
        }
      }

      function openTab(evt, tabName) {
        // Hide all tab panes
        const tabPanes = document.getElementsByClassName("tab-pane");
        for (let i = 0; i < tabPanes.length; i++) {
          tabPanes[i].classList.remove("active");
        }

        // Remove "active" class from all buttons
        const tabBtns = document.getElementsByClassName("tab-btn");
        for (let i = 0; i < tabBtns.length; i++) {
          tabBtns[i].classList.remove("active");
        }

        // Show current tab and add active class to button
        document.getElementById(tabName).classList.add("active");
        evt.currentTarget.classList.add("active");
      }

      async function loginUser(autoID = null) {
        const idInput = document.getElementById("student-id-input");
        const id = autoID || idInput.value.trim();

        if (!id) return alert("Enter Student ID");

        const form = document.createElement("form");
        form.method = "POST";
        form.action = "/auth/login";

        const userField = document.createElement("input");
        userField.type = "hidden";
        userField.name = "username";
        userField.value = id;

        const passField = document.createElement("input");
        passField.type = "hidden";
        passField.name = "password";
        passField.value = ""; // Placeholder for research version

        form.appendChild(userField);
        form.appendChild(passField);
        document.body.appendChild(form);

        // Save current ID as the last used ID
        localStorage.setItem("knhs_student_id", id);

        form.submit();
      }

      let bldgMarkers = []; // Store markers so we can change them later

      function loadBuildingLabels() {
    // Clear existing
    bldgMarkers.forEach((m) => map.removeLayer(m));
    bldgMarkers = [];

    BUILDINGS.forEach((b) => {
        // Create an invisible marker/hitbox for the building
        const marker = L.marker(b.coords, { 
            interactive: true // Allow mouse interactions
        }).addTo(map);

        marker.bldgData = {
            name: b.name,
            short: b.name.replace("BLDG ", ""),
        };

        // --- HOVER EVENTS ---
        marker.on('mouseover', function() {
            const iconElement = this.getElement();
            if (iconElement) iconElement.classList.add('label-visible');
        });

        marker.on('mouseout', function() {
            const iconElement = this.getElement();
            if (iconElement) iconElement.classList.remove('label-visible');
        });

        bldgMarkers.push(marker);
    });

    updateLabels();
    map.on("zoomend", updateLabels);
}

function updateLabels() {
    const currentZoom = map.getZoom();

    bldgMarkers.forEach((marker) => {
        let newIcon;
        // Logic: Still use different styles based on zoom, but kept at opacity 0 via CSS
        if (currentZoom >= 20) {
            newIcon = L.divIcon({
                className: "bldg-text", 
                html: marker.bldgData.name,
                iconSize: [60, 20],
                iconAnchor: [30, 10],
            });
        } else {
            newIcon = L.divIcon({
                className: "bldg-dot",
                html: marker.bldgData.short,
                iconSize: [24, 24],
                iconAnchor: [12, 12],
            });
        }
        marker.setIcon(newIcon);
        
        // Hide markers entirely if zoomed out too far
        if (currentZoom < 16) {
            marker.getElement()?.style.setProperty('display', 'none');
        } else {
            marker.getElement()?.style.setProperty('display', 'block');
        }
    });
}

      function findNearestBuilding(userLatLng) {
        let nearest = null;
        let minDist = Infinity;

        BUILDINGS.forEach((b) => {
          const dist = map.distance(userLatLng, b.coords);
          if (dist < minDist) {
            minDist = dist;
            nearest = b;
          }
        });

        const badge = document.getElementById("nearest-bldg-badge");
        if (nearest && badge) {
          if (minDist < 60) {
            // Only show if within 60 meters
            badge.innerText = `Near: ${nearest.name}`;
            badge.style.background = "#e0f2fe"; // Light Blue
            badge.style.color = "#0369a1";
          } else {
            badge.innerText = "Outside Campus Area";
            badge.style.background = "#f1f5f9";
            badge.style.color = "#64748b";
          }
        }
      }
    </script>
  </body>
</html>